# Blueprint for Google Cloud Infrastructure Manager (Terraform YAML syntax)

inputs:
  region:
    default: us-central1
  zone:
    default: us-central1-a
  network_name:
    default: boundary-vm-network
  subnet_name:
    default: boundary-vm-subnet
  subnet_cidr:
    default: 10.1.0.0/24
  vm_machine_type:
    default: e2-micro
  vm_image:
    default: projects/centos-cloud/global/images/centos-stream-9-arm64-v20250513
  admin_username:
    default: gcpuser
  ssh_public_key:
    description: SSH public key for the VM
    default: "gcpuser:<replace-me>"

resources:
  # VPC Network
  - name: network
    type: compute.v1.network
    properties:
      name: ${input.network_name}
      autoCreateSubnetworks: false

  # Subnet
  - name: subnet
    type: compute.v1.subnetwork
    properties:
      name: ${input.subnet_name}
      region: ${input.region}
      network: ${resource.network.selfLink}
      ipCidrRange: ${input.subnet_cidr}

  # Firewall for SSH
  - name: allow-ssh
    type: compute.v1.firewall
    properties:
      name: boundary-vm-allow-ssh
      network: ${resource.network.selfLink}
      allowed:
        - IPProtocol: tcp
          ports: ["22"]
      sourceRanges: ["0.0.0.0/0"]
      targetTags: ["boundary-vm"]

  # Public IPs
  - name: boundary-vm-1-ip
    type: compute.v1.address
    properties:
      region: ${input.region}
  - name: boundary-vm-2-ip
    type: compute.v1.address
    properties:
      region: ${input.region}
  - name: boundary-vm-3-ip
    type: compute.v1.address
    properties:
      region: ${input.region}
  - name: boundary-vm-4-ip
    type: compute.v1.address
    properties:
      region: ${input.region}

  # VM Instances
  - name: boundary-vm-1
    type: compute.v1.instance
    properties:
      zone: ${input.zone}
      machineType: zones/${input.zone}/machineTypes/${input.vm_machine_type}
      tags:
        items: ["boundary-vm", "dev"]
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            sourceImage: ${input.vm_image}
            diskType: pd-standard
      networkInterfaces:
        - network: ${resource.network.selfLink}
          subnetwork: ${resource.subnet.selfLink}
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT
              natIP: ${resource.boundary-vm-1-ip.address}
      metadata:
        items:
          - key: ssh-keys
            value: ${input.ssh_public_key}

  - name: boundary-vm-2
    type: compute.v1.instance
    properties:
      zone: ${input.zone}
      machineType: zones/${input.zone}/machineTypes/${input.vm_machine_type}
      tags:
        items: ["boundary-vm", "dev"]
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            sourceImage: ${input.vm_image}
            diskType: pd-standard
      networkInterfaces:
        - network: ${resource.network.selfLink}
          subnetwork: ${resource.subnet.selfLink}
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT
              natIP: ${resource.boundary-vm-2-ip.address}
      metadata:
        items:
          - key: ssh-keys
            value: ${input.ssh_public_key}

  - name: boundary-vm-3
    type: compute.v1.instance
    properties:
      zone: ${input.zone}
      machineType: zones/${input.zone}/machineTypes/${input.vm_machine_type}
      tags:
        items: ["boundary-vm", "production"]
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            sourceImage: ${input.vm_image}
            diskType: pd-standard
      networkInterfaces:
        - network: ${resource.network.selfLink}
          subnetwork: ${resource.subnet.selfLink}
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT
              natIP: ${resource.boundary-vm-3-ip.address}
      metadata:
        items:
          - key: ssh-keys
            value: ${input.ssh_public_key}

  - name: boundary-vm-4
    type: compute.v1.instance
    properties:
      zone: ${input.zone}
      machineType: zones/${input.zone}/machineTypes/${input.vm_machine_type}
      tags:
        items: ["boundary-vm", "prod"]
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            sourceImage: ${input.vm_image}
            diskType: pd-standard
      networkInterfaces:
        - network: ${resource.network.selfLink}
          subnetwork: ${resource.subnet.selfLink}
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT
              natIP: ${resource.boundary-vm-4-ip.address}
      metadata:
        items:
          - key: ssh-keys
            value: ${input.ssh_public_key}

outputs:
  vm_public_ips:
    value:
      - ${resource.boundary-vm-1-ip.address}
      - ${resource.boundary-vm-2-ip.address}
      - ${resource.boundary-vm-3-ip.address}
      - ${resource.boundary-vm-4-ip.address}
  ssh_commands:
    value:
      - "ssh ${input.admin_username}@${resource.boundary-vm-1-ip.address}"
      - "ssh ${input.admin_username}@${resource.boundary-vm-2-ip.address}"
      - "ssh ${input.admin_username}@${resource.boundary-vm-3-ip.address}"
      - "ssh ${input.admin_username}@${resource.boundary-vm-4-ip.address}"
